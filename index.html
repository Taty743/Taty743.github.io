<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner de Códigos de Barras</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>
<body>
    <h1>Escáner de Códigos de Barras</h1>

    <!-- Elemento de video para mostrar el feed de la cámara -->
    <video id="video" width="300" height="300" autoplay></video>

    <p>Código de barras escaneado: <span id="output"></span></p>

    <h2>Códigos de barras escaneados:</h2>
    <ul id="barcode-list"></ul>

    <script>
        const output = document.getElementById("output");
        const barcodeList = document.getElementById("barcode-list");

        // Función para verificar si la fecha está en el pasado (formato DD/MM/YYYY)
        function isPastDate(dateStr) {
            const dateParts = dateStr.split('/');
            const day = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1; // Mes base 0
            const year = parseInt(dateParts[2], 10);
            const scannedDate = new Date(year, month, day);
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0); // Sin la parte de hora para comparación
            return scannedDate < currentDate;
        }

        // Función para iniciar la cámara
        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(stream) {
                    const videoElement = document.getElementById('video');
                    videoElement.srcObject = stream;

                    // Inicializar QuaggaJS cuando el video está listo
                    videoElement.onloadedmetadata = function () {
                        Quagga.init({
                            inputStream: {
                                name: "Live",
                                type: "LiveStream",
                                target: document.querySelector("#video"),
                                constraints: {
                                    facingMode: "environment"
                                }
                            },
                            decoder: {
                                readers: ["ean_reader", "code_128_reader", "upc_reader"]
                            }
                        }, function(err) {
                            if (err) {
                                console.error("Error al inicializar QuaggaJS:", err);
                                return;
                            }
                            Quagga.start(); // Empezar la detección de código de barras
                        });
                    };
                })
                .catch(function(error) {
                    console.error("Error al acceder a la cámara: ", error);
                });
        }

        // Función para manejar el código de barras detectado
        function handleDetectedBarcode(barcode) {
            // Mostrar el código de barras en la página
            if (output.textContent !== barcode) {
                output.textContent = barcode;

                // Crear un nuevo elemento de lista y agregarlo
                const listItem = document.createElement("li");
                listItem.textContent = barcode;

                // Extraer la fecha y el texto adicional
                const dateMatch = barcode.match(/^(\d{2}\/\d{2}\/\d{4})/); // Buscar la fecha al principio
                if (dateMatch) {
                    const dateStr = dateMatch[1]; // Fecha encontrada

                    // Verificar si la fecha está en el pasado
                    if (isPastDate(dateStr)) {
                        const extraText = barcode.replace(dateStr, '').trim(); // Texto posterior a la fecha
                        alert(`"${extraText}" está caducado.`); // Mostrar el mensaje
                    }
                }

                barcodeList.appendChild(listItem);
            }
        }

        // Configuración de QuaggaJS para detectar el código de barras
        Quagga.onDetected(function(result) {
            const barcode = result.codeResult.code;
            handleDetectedBarcode(barcode); // Manejar el código de barras detectado
        });

        // Iniciar la cámara y QuaggaJS cuando se carga la página
        window.onload = function() {
            startCamera();
        };
    </script>
</body>
</html>
